<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, user-scalable=yes">

  <title>client</title>
  <meta name="description" content="client description">

  <style media="screen">
    body {
      background-color: #303030;
      filter: invert(100%);
    }

    .button {
      border: 1px solid black;
      display: inline-flex;
      padding: 12px;
    }
  </style>
</head>
  <section id=states></section>
  <section id=actions>
    <div id=shop class=button onclick="fetchShop()">shop</div>
  </section>
  <hr />
  <div id=me></div>
  <script>
    let fetchShop = function(e) {
      console.log(e)
    }

    fetch('/me').then(e => e.text().then(_ => {
      let me = JSON.parse(_)
      document.querySelector('#me').innerText = _

      // Create WebSocket connection.
      let socket = new WebSocket('ws://multivers.adebray.ovh/' + me.token + '.ws');

      // Connection opened
      socket.addEventListener('open', function (event) {
          socket.send('Hello Server!');

          fetch('/states').then(e => e.json().then(_ => {
            _.forEach(s => {
              let d = document.createElement('div')
              d.innerText = me.state == s ? `stop ${s}` : s
              d.id = s
              d.className += 'button'
              d.addEventListener('click', () => {
                fetch(s).then(() => {
                  let _ = d.innerText.match(/stop (.*)/)
                  if (_)
                    d.innerText = _[1]
                }).catch(console.error)
              })
              document.querySelector('#states').appendChild(d)
            })
          }))
      });

      // Listen for messages
      socket.addEventListener('message', function (event) {
          console.log('Message from server ', event.data);
          let _ = JSON.parse(event.data)
          if (_.cmd == 'me')
            fetch('/me').then(e => e.text().then(_ => {
              let me = JSON.parse(_)
              document.querySelector('#me').innerText = _
              if (me.state != 'idle') {
                console.log(me.state)
                console.log(document.querySelector(`#${me.state}`))
                document.querySelector(`#${me.state}`).innerText = `stop ${me.state}`
              }
            }))
      });
    }))

  </script>
</html>
