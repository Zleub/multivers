/* @flow */

import {end, time, flattenDeep} from './utils'

import Drawable, {config, type Drawable_t} from './Drawable'
import Tileset from './Tileset'
import Player from './Player'
import World, {world, addPlayer} from './World'
import {openSimplex} from './Map'
import move from './Movement'
import { computeFOV } from './FOV'
import Wiki from './Wiki'

import fs, { writeFileSync } from 'fs'

import express from 'express'
import {app, ws_app} from './express'

if (process.argv.find(e => e == '--log' || e == '-l'))
  writeFileSync("multivers.log", "")

addPlayer(world, new Player(world, {
  name: "local",
  ip: "127.0.0.1",
}))

// Tileset({
//   path: 'assets/lpc-terrains/',
//   tilemap: 'terrain-v7.tsx'
// })

/** What yp ? */
let isUser = (req: express$Request, res, next) => {
  if (world.players.filter(e => e.ip == req.connection.remoteAddress)[0])
    next()
  else {
    res.status(400).end()
  }
}

let debug = (req: express$Request, res, next) => {
  console.log(`${req.url}: ${req.headers.user ? req.headers.user.name : "no user defined"}`)
  next()
}

process.argv.push('-c', 'jingo.yaml')
console.log(process.argv)

let jingo = require('./jingo').default
// import jingo from 'jingo'

jingo.on('ready', jingo_app => {

  app.use(debug)

  /**
   * @api {get} / root
   * @apiName Root
   * @apiGroup All
   */
  app.use('/', express.static('client'))
  app.use('/api', express.static('docs/apidoc'))
  app.use('/doc', express.static('docs/reference'))
  app.use('/wiki', jingo_app)

  require('./get').default(app)

  /**
   * @api {get} /tile/:name Access a particular tile
   * @apiName tile
   * @apiGroup User
   */
  app.get('/tile/:name', isUser, (req: express$Request, res: express$Response) => {
    // console.log(world.tiles, req.params.name)
    res.end( JSON.stringify(world.tiles[req.params.name]) )
  })

  app.listen(4242, 'localhost')

  end('init');

})

// console.log('Hello', jingo)
// console.log('Hello', app === ws_app)

// let jingo = require('child_process').spawn('jingo', ['-c', 'jingo.yaml'])
// jingo.stdout.on('data', (data) => {
//   process.stdout.write(`jingo stdout: ${data}`);
// });
//
// jingo.stderr.on('data', (data) => {
//   process.stdout.write(`jingo stderr: ${data}`);
// });
//
// jingo.on('close', (code) => {
//   process.stdout.write(`child process exited with code ${code}`);
// });
//
// setTimeout(function () {
//   require('child_process').exec(`curl -L --cookie-jar jarfile --data "username=adebray&password=asd" http://localhost:6067/login`, (err, stdout, stderr) => {
//     // console.log(stdout)
//     console.log(stderr)
//     require('child_process').exec(`curl -L --cookie jarfile \
//       --header 'content-type: application/x-www-form-urlencoded' \
//       --data 'pageTitle=Home&_method=put&content=ready&message=' \
//       http://localhost:6067/pages/Home`, (err, stdout, stderr) => {
//         console.log(stdout)
//         console.log(stderr)
//       }
//     )
//   })
// }, 4000);
